<html>
	<head>
		<title>Virtual Lab</title>
		<style>
      .lineChart {
        position: relative;
        float:left;
        margin-left: 0;
        width: 30%;
      }

		</style>
		<script src="js/d3.v4.js"></script>
		<script src="js/jquery-3.5.1.min.js"></script>
		<script src="js/VLApi.js"></script>
		<script src="js/DynamicLineChart.js"></script>
	</head>
	<body>
    <input id="sampleCreate" type="button" value="Create Sample" onclick="createNewSample()">
    <div id="my_dataviz" class="lineChart"></div>
    <div id="my_dataviz2" class="lineChart"></div>
    <div id="my_dataviz3" class="lineChart"></div>
	</body>

	<script>
        var samples = [];
        var modelList = null;
        var currentNum = 0;

        var api = new VLApi();
        $( document ).ready(function() {

          api.getModels().then(function(models) {
            console.log(models);
            modelList = models;
          });
        });

        function createNewSample() {
          console.log(modelList);
          if (modelList) {
            let model = modelList[3];//cell
            //let model = modelList[4];//nmodel
            model.getParameters().then(function(params) {
              for (var key in params) {
                if (!(typeof params[key] === 'object')) {
                  let scale = function(val) {
                    if (getParamMetaData(params, key, "scale", "linear") == "log") {
                      return Math.log(val);
                    }
                    else {
                      return val;
                    }
                  };
                  let inv_scale = function(val) {
                    if (getParamMetaData(params, key, "scale", "linear") == "log") {
                      return Math.exp(val);
                    }
                    else {
                      return val;
                    }
                  };
                  var val = scale(params[key]);
                  let min = scale(getParamMetaData(params, key, "min", val));
                  let max = scale(getParamMetaData(params, key, "max", val));
                  //val = Math.random()*(max - min) + min;
                  val = (Math.random()*0.1-0.05)*(max - min) + val;
                  params[key] = inv_scale(val);
                }
              }
              //params.cpool = 80;
              /*
              0.1
0.22269585080133
0.495934419641283
1.1044253752368
2.45950948584936
5.47722557505166
12.1975540946693
27.1634468680764
60.49186910983
134.712882579763
300
*/
              createSample(model, "a"+currentNum, params, 0.1, currentNum).then( function() {
                  createSample(model, "a"+currentNum, params, 1, currentNum)
                .then( function() {
                  createSample(model, "a"+currentNum, params, 3, currentNum)
                .then( function() {
                  createSample(model, "a"+currentNum, params, 10, currentNum)
                .then( function() {
                  createSample(model, "a"+currentNum, params, 30, currentNum)
                .then( function() {
                  createSample(model, "a"+currentNum, params, 100, currentNum)
                .then( function() {
                  createSample(model, "a"+currentNum, params, 300, currentNum)
                  currentNum+=20;
                  console.log("Sample Created");
                })})})})})});
            });
          }
        }

        function updateSample(sample) {
          sample.update().then(function(data) {
              sample.nav.t += 10.0;//10.0*60;
              //sample.nav.t += 10.0*60;
              if (sample.nav.t < 3600*6) {
                updateSample(sample);
              }
              lineChart1.updateData(samples, function(d) {return d.name;}, function(d) {return d.params.substrate_k;}, function(d) {return d.data.mean_aflow;});
              lineChart2.updateData(samples, function(d) {return d.name;}, function(d) {return d.params.substrate_k;}, function(d) {return d.data.mean_traction;});
              lineChart3.updateData(samples, function(d) {return d.name;}, function(d) {return d.params.substrate_k;}, function(d) {return d.data.rmc;});
          });
        }

        function createSample(model, name, params, k, num) {   
          return new Promise(function(resolve, reject) {       
                var p = JSON.parse(JSON.stringify(params));
                p.substrate_k = k;
                p.num = num;
                model.create(p).then(function(sample) { 
                    //console.log("samples", name, k);
                    sample.name = name;
                    sample.nav.t = 10;//3600.0;
                    //sample.nav.t = 3600.0;
                    samples.push(sample);
                    resolve();
                    updateSample(sample);
                });
          });
        }

        var lineChart1 = new DynamicLineChart("my_dataviz");
        var lineChart2 = new DynamicLineChart("my_dataviz2");
        var lineChart3 = new DynamicLineChart("my_dataviz3");
        
        </script>
</html>
