<html>
	<head>
		<title>Virtual Lab</title>
		<style>
        </style>

		</style>
		<script src="js/d3.v4.js"></script>
		<script src="js/jquery-3.5.1.min.js"></script>
		<script src="js/VLApi.js"></script>
	</head>
	<body>
        <div id="my_dataviz"></div>
	</body>

	<script>
        var samples = [];

        var api = new VLApi();
        $( document ).ready(function() {
          api.getModels().then(function(models) {
            console.log(models);
            let model = models[4];
            createSample(model, "a", 0.1).then( function() {
              createSample(model, "a", 1)
            .then( function() {
              createSample(model, "a", 10)
            .then( function() {
              createSample(model, "a", 300)
            .then( function() {
              createSample(model, "b", 0.2)
            .then( function() {
              createSample(model, "b", 1.1)
            .then( function() {
              createSample(model, "b", 10.1)
            .then( function() {
              createSample(model, "b", 299.9);
            })})})})})})})/**/
            
            /*createSample(model, "a", 20);
            createSample(model, "a", 30);
            createSample(model, "b", 1.1);
            createSample(model, "b", 9.9);
            createSample(model, "b", 19.9);
            createSample(model, "b", 29.9);*/
          });
        });

        function updateSample(sample) {
          sample.update().then(function(data) {
              sample.nav.t += 10.0;
              console.log(sample.data);
              updateSample(sample);
              updateLines(samples, function(d) {return d.name;}, function(d) {return d.params.substrate_k;}, function(d) {return d.data.vel;});
          });
        }

        function createSample(model, name, k) {   
          return new Promise(function(resolve, reject) {       
            model.getParameters().then(function(params) {
                console.log("params", name, k);
                params.substrate_k = k;
                model.create(params).then(function(sample) { 
                    console.log("samples", name, k);
                    sample.name = name;
                    sample.nav.t = 10.0;
                    samples.push(sample);
                    resolve();
                    updateSample(sample);
                });
            });
          });
        }

        // set the dimensions and margins of the graph
        var margin = {top: 10, right: 30, bottom: 30, left: 60},
            width = 460 - margin.left - margin.right,
            height = 400 - margin.top - margin.bottom;
        
        // append the svg object to the body of the page
        var svg = d3.select("#my_dataviz")
          .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
          .append("g")
            .attr("transform",
                  "translate(" + margin.left + "," + margin.top + ")");
        
        /*var lineKey = "name";
        var xKey = "year";
        var yKey = "n";*/
        var xAxis = null;
        var yAxis = null;

        function updateLines(samples, lineKey, xKey, yKey) {
          var data = samples;
          //var data = [{year:1234, name:"toast", n:1234}, {year:1235, name:"toast", n:2346}, {year:1235, name:"abc", n:200}, {year:1234, name:"abc", n:300}];
          //Read the data
          //d3.csv("https://raw.githubusercontent.com/holtzy/data_to_viz/master/Example_dataset/5_OneCatSevNumOrdered.csv", function(data) {
          
            // group the data: I want to draw one line per group
            var sumstat = d3.nest() // nest function allows to group the calculation per level of a factor
              .key(function(d) { return lineKey(d);})
              .entries(data);
          
            // Add X axis --> it is a date format
            var x = d3.scaleLog()
              .domain(d3.extent(data, function(d) { return +xKey(d); }))
              .range([ 0, width ]);
            if (!xAxis) {
              xAxis = svg.append("g")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(x).ticks(5));
              }
            else {
              xAxis.call(d3.axisBottom(x))
            }
          
            // Add Y axis
            var y = d3.scaleLinear()
              .domain([0, d3.max(data, function(d) { return +yKey(d); })])
              .range([ height, 0 ]);
            if (!yAxis) {
              yAxis = svg.append("g")
                .call(d3.axisLeft(y));
            }
            else {
              yAxis.call(d3.axisLeft(y))
            }

            // color palette
            var res = sumstat.map(function(d){ return d.key }) // list of group names
            var color = d3.scaleOrdinal()
              .domain(res)
              .range(['#e41a1c','#377eb8','#4daf4a','#984ea3','#ff7f00','#ffff33','#a65628','#f781bf','#999999'])
          
            svg.selectAll(".line")
              .data(sumstat)
              .exit()
              .remove()

            console.log(sumstat);

            svg.selectAll(".line")
                .data(sumstat)
                .exit()
                .remove();

            // Draw the line
            svg.selectAll(".line")
                .data(sumstat)
                .enter()
                .append("path")
                  .attr("class","line")
                  .attr("fill", "none")
                  .attr("stroke", function(d){ return color(d.key) })
                  .attr("stroke-width", 1.5)
                  .attr("d", function(d){
                    return d3.line()
                      .x(function(d) { return x(xKey(d)); })
                      .y(function(d) { return y(+yKey(d)); })
                      (d.values)
                  });

            svg.selectAll(".line")
                .data(sumstat)
                .attr("d", function(d){
                    return d3.line()
                      .x(function(d) { return x(xKey(d)); })
                      .y(function(d) { return y(+yKey(d)); })
                      (d.values)
                  });
        }
        
        //})
        
        </script>
</html>
