<html>
	<head>
		<title>Virtual Lab</title>
		<style>
      .lineChart {
        position: relative;
        float:left;
        margin-left: 0;
        width: 30%;
      }

		</style>
		<script src="js/d3.v4.js"></script>
		<script src="js/jquery-3.5.1.min.js"></script>
		<script src="js/VLApi.js"></script>
		<script src="js/DynamicLineChart.js"></script>
	</head>
	<body>
    <input id="sampleCreate" type="button" value="Create Sample" onclick="createNewSample()">
    <div id="my_dataviz" class="lineChart"></div>
    <div id="my_dataviz2" class="lineChart"></div>
    <div id="my_dataviz3" class="lineChart"></div>
	</body>

	<script>
        var samples = [];
        var modelList = null;
        var currentNum = 0;

        var api = new VLApi();
        $( document ).ready(function() {

          api.getModels().then(function(models) {
            console.log(models);
            modelList = models;
            /*let model = models[5];
            createSample(model, "a", 0.1, 0).then( function() {
              createSample(model, "a", 1, 0)
            .then( function() {
              createSample(model, "a", 10, 0)
            .then( function() {
              createSample(model, "a", 300, 0)
            .then( function() {
              createSample(model, "b", 0.1, 1)
            .then( function() {
              createSample(model, "b", 1, 1)
            .then( function() {
              createSample(model, "b", 10, 1)
            .then( function() {
              createSample(model, "b", 300, 1);
            })})})})})})})/**/
            
            /*createSample(model, "a", 20);
            createSample(model, "a", 30);
            createSample(model, "b", 1.1);
            createSample(model, "b", 9.9);
            createSample(model, "b", 19.9);
            createSample(model, "b", 29.9);*/
          });
        });

        function createNewSample() {
          console.log(modelList);
          if (modelList) {
            let model = modelList[5];
            createSample(model, "a"+currentNum, 0.1, currentNum).then( function() {
                createSample(model, "a"+currentNum, 1, currentNum)
              .then( function() {
                createSample(model, "a"+currentNum, 10, currentNum)
              .then( function() {
                createSample(model, "a"+currentNum, 300, currentNum)
                currentNum++;
              })})});
          }
        }

        function updateSample(sample) {
          sample.update().then(function(data) {
              sample.nav.t += 10.0;
              console.log(sample.data);
              updateSample(sample);
              lineChart1.updateData(samples, function(d) {return d.name;}, function(d) {return d.params.substrate_k;}, function(d) {return d.data.mean_aflow;});
              lineChart2.updateData(samples, function(d) {return d.name;}, function(d) {return d.params.substrate_k;}, function(d) {return d.data.mean_traction;});
              lineChart3.updateData(samples, function(d) {return d.name;}, function(d) {return d.params.substrate_k;}, function(d) {return d.data.rmc;});
          });
        }

        function createSample(model, name, k, num) {   
          return new Promise(function(resolve, reject) {       
            model.getParameters().then(function(params) {
                console.log("params", name, k);
                params.substrate_k = k;
                params.num = num;
                model.create(params).then(function(sample) { 
                    console.log("samples", name, k);
                    sample.name = name;
                    sample.nav.t = 30.0;
                    samples.push(sample);
                    resolve();
                    updateSample(sample);
                });
            });
          });
        }

        var lineChart1 = new DynamicLineChart("my_dataviz");
        var lineChart2 = new DynamicLineChart("my_dataviz2");
        var lineChart3 = new DynamicLineChart("my_dataviz3");
        console.log(lineChart1);
        
        </script>
</html>
