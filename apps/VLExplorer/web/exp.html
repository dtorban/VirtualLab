<html>
	<head>
		<title>Virtual Lab</title>
		<style>
      .lineChart {
        position: relative;
        float:left;
        margin-left: 0;
        width: 20%;
        height: 100%;
      }
      .dynamicsChart {
        position: relative;
        float:left;
        width: 50%;
        height: 150px;
      }
      #dynamics-tab {
        position: absolute;
          width: 100%;
          height: 100%;
      }
      #data-tab {
        position: absolute;
          width: 100%;
          height: 100%;
      }
      #dynamics-charts {
        width: 50%;
        height: 100%;
        overflow-y: auto;
      }
      .popup {
        position: absolute;
        top: 50%;  /* position the top  edge of the element at the middle of the parent */
        left: 50%; /* position the left edge of the element at the middle of the parent */

        transform: translate(-50%, -50%); /* This is a shorthand of
                                            translateX(-50%) and translateY(-50%) */
        border: 1px solid;
        background-color: #F0F0F0;
      }
      .nav {position: relative; float: left; padding: 10px; width: 10%;}
      .toolbar {margin: 10px; text-align: center; width: 50px; border: 1px solid; padding: 10px;}
      .tool {background-color: rgb(79, 89, 90); width: 30px; height: 30px;margin: auto;margin-top: 10px;}
      .workarea {position: relative; float: left; margin: 10px; width: 85%; height: 90%;}
      .parent {display: block;position: relative;float: left;line-height: 30px;background-color: #4FA0D8;border-right:#CCC 1px solid;}
      .parent a{margin: 10px;color: #FFFFFF;text-decoration: none;}
      .parent:hover > ul {display:block;position:absolute;}
      .child {display: none;;z-index: 1;}
      .child li {background-color: #E4EFF7;line-height: 30px;border-bottom:#CCC 1px solid;border-right:#CCC 1px solid; width:100%;;z-index: 1;}
      .child li a{color: #000000;z-index: 1;}
      ul{list-style: none;margin: 0;padding: 0px; min-width:10em;}
      ul ul ul{left: 100%;top: 0;margin-left:1px;}
      li:hover {background-color: #95B4CA;}
      .parent li:hover {background-color: #F0F0F0;}
      .expand{font-size:12px;float:right;margin-right:5px;}
      #header{height: 50px; margin-top: 20px;}
      .sampling{margin-top: 2px;margin-bottom: 2px; font-size: small;}
      .sample{margin-top: 2px;margin-bottom: 2px; font-size: small;white-space: nowrap;}
      .section-title{margin-top: 15px;margin-bottom: 10px;font-weight: bold;}
      #samples{overflow: auto; height: 300px;}
      progress {
				background-color: #c0bdbd;
				width: 30px;
				margin-right: 10px;
			}
      #pcc {
				width: 100%;
				height: 20%;
			}
      input[type="file"] {
          display: none;
      }
      .custom-file-upload {
          /*border: 1px solid #ccc;*/
          display: inline-block;
          padding: 0px 12px;
          z-index: 1;
          cursor: pointer;
      }
      .data-view {
          width: 100%;
          height: 25%;
      }
      .spatial {
        position: relative;
        float: left;
          width: 50%;
          height: 55%;
          overflow-y: auto;
      }
		</style>
		<script src="js/d3.v4.js"></script>
		<script src="js/jquery-3.5.1.min.js"></script>
		<script src="js/VLApi.js"></script>
		<script src="js/DynamicLineChart.js"></script>
		<script src="js/SamplingStrategy.js"></script>
		<script src="js/pcc.js"></script>
		<script src="js/SpatialCell.js"></script>
	</head>
	<body>
    <div id="header">
      <ul id="menu">
        <li class="parent"><a href="#">File</a>
        <ul class="child">
          <li class="parent"><a href="#">Export <span class="expand">&gt;</span></a>
            <ul class="child">
              <li><a href="#" onclick="exportCSV()">CSV</a></li>
              <li><a href="#" onclick="exportJSON()">JSON</a></li>
            </ul>
          </li>
          <li>
            <label class="custom-file-upload">
              <input type="file" id="files" name="files[]" multiple />
              <i class="fa fa-cloud-upload parent"></i> Import
            </label>
          </li>
        </ul>
        </li>
        <li class="parent"><a href="#">View</a>
          <ul class="child">
            <li><a href="#" onclick="setTab(0)">Data / Spatial</a></li>
            <li><a href="#" onclick="setTab(1)">Dynamics</a></li>
          </ul>
        </li>
        <li class="parent"><a href="#">Window</a>
        </li>
      </ul>
    </div>



    <div class="workarea">
      <div id="data-tab">
        <div id="pcc"></div>
        <div class="data-view">
          <div id="my_dataviz" class="lineChart"></div>
          <div id="my_dataviz2" class="lineChart"></div>
          <div id="my_dataviz3" class="lineChart"></div>
          <div id="my_dataviz4" class="lineChart"></div>
          <div id="my_dataviz5" class="lineChart"></div>
        </div>
        <div id="spatial" class="spatial"></div>
        <div id="spatialPath" class="spatial"></div>
    </div>
      <div id="dynamics-tab">
        <div id="dynamics-charts"></div>
        <!--div id="param1" class="dynamicsChart"></div>
        <div id="param2" class="dynamicsChart"></div>
        <div id="param3" class="dynamicsChart"></div-->
      </div>
    </div>

    <div class="nav">
      <!--div class="toolbar">
        <div>Tools</div>
        <div class="tool"></div>
        <div class="tool"></div>
        <div class="tool"></div>
        <div class="tool"></div>
      </div-->
      <div>
        <div class="section-title">Sampling Methods</div>
        <div id="samplingMethods">
          <div class="sampling"><div style="position:relative; float:left; width: 75px;">Low </div><input type="button" value="+" onclick="createNewSample()"></div>
          <!--div class="sampling"><div style="position:relative; float:left; width: 75px;">High </div> <input type="button" value="+" onclick="createNewSample()"></div-->
        </div>
        <!--input id="createSampling" type="button" value="Create Sampling" onclick="$('.popup').hide();$('#sampling').show();"-->
        <!--input id="sampleCreate" type="button" value="Create Sample" onclick="createNewSample()"-->
        <!--input id="toggleSim" type="button" value="Toggle Sim" onclick="running = !running;"-->
      </div>

      <div>
        <div class="section-title">Samples</div>
        <div id="samples">
        </div>
        <input type="checkbox" onchange="groupSamples = !groupSamples;" checked>Group Samples
        <input type="button" value="Clear" onclick="selectAll(false)">
        <input type="button" value="Select All" onclick="selectAll(true)">
        <input type="button" value="Invert" onclick="invertSelect()">
        <input type="button" value="Select Range" onclick="selectRange()"><br>
        <input type="button" value="Interpolate Color" onclick="interpColor()"><br>
        <input type="button" value="Delete Samples" onclick="deleteSamples()">
        <!--input type="button" value="Create Template"><input type="button" value="Interpolate" onclick="interpolate(samples[0].params, samples[1].params, 3);"-->
      </div>

    </div>


    <div id="adhoc" class="popup">
      <table id="adhoc-params"></table>
      <div>Sample Name: <input id="adhoc-name" type="text"></div>
      <input id="adhoc-button" type="button" value="Submit">
    </div>


	</body>
	<script>
      d3.rgb.prototype.toHex = function() {
        var r = Math.round(this.r).toString(16);
        var g = Math.round(this.g).toString(16);
        var b = Math.round(this.b).toString(16);
        if(this.r < 16) r = "0" + r;
        if(this.g < 16) g = "0" + g;
        if(this.b < 16) b = "0" + b;
        return "#"+r+g+b;
      }

        var samples = [];
        var sampleIndexLookup = {};
        var modelList = null;
        var currentNum = 0;
        var simulations = 0;
        var running = true;
        var samplingMethods = [];
        var model = null;
        var groupSamples = true;
        var tab = 1;
        var checkMultiple = false;
        var dynamicsCharts = {};

        var color = d3.scaleLinear().domain([0,1])
          .range(["#b8c1f5", "blue"])
        console.log(color(0));
        console.log(color(0.55));

        var api = new VLApi();
        $( document ).ready(function() {
          $('.popup').hide();
          setTab(tab);

          api.getModels().then(function(models) {
            console.log(models);
            modelList = models;

            model = modelList[6];

            model.getParameters().then(function(params) {
              samplingMethods.push(new SamplingStrategy(params, "Ad Hoc", function(params, callback, samplingMethod) {
                if (samplingMethod.createNum == samplingMethod.numSamples) {
                  $("#adhoc").show();
                  $("#adhoc-params").html("");
                  var input = {};
                  Object.keys(params).forEach(function(key, index) {
                    if (!(typeof params[key] === 'object')) {
                      console.log(key, params[key]);
                      var tr = $("<tr></tr>");
                      var name = $("<td>" + key + "</td>");
                      var val = $("<td></td>");
                      var inputText = $("<input type='text' value='"+ params[key] +"' size='4'>")
                      input[key] = inputText;
                      val.append(inputText);
                      tr.append(name);
                      tr.append(val);
                      $('#adhoc-params').append(tr);
                    }
                  });
                  $( "#adhoc-button" ).click(function() {
                    samplingMethod.currentInput = input;
                    Object.keys(input).forEach(function(key, index) {
                      params[key] = +input[key].val();
                    });
                    callback($("#adhoc-name").val());
                    $("#adhoc").hide();
                    $("#adhoc-button").unbind();
                  });
                }
                else {
                  let input = samplingMethod.currentInput;
                    Object.keys(input).forEach(function(key, index) {
                      params[key] = +input[key].val();
                  });
                  callback($("#adhoc-name").val());
                }
              }));
              samplingMethods.push(new SamplingStrategy(params, "Random", function(params, callback) {
                //var p = JSON.parse(JSON.stringify(interpolate(samples[0].params,samples[1].params, 10)));
                Object.keys(params).forEach(function(key, index) {
                  if (!(typeof params[key] === 'object')) {
                    var r = Math.random();
                    params[key] = lerpParamMetaData(params, key, getParamMetaData(params, key, "min", params[key]), getParamMetaData(params, key, "max", params[key]), r);
                  }
                });
                callback("Random-" + currentNum);
              }));
              samplingMethods.push(new SamplingStrategy(params, "Search"));
              samplingMethods.push(new SamplingStrategy(params, "More", function(params, callback, samplingMethod) {
                if (samplingMethod.createNum == samplingMethod.numSamples) {
                  for (var i = 0; i < samples.length; i++) {
                    if (samples[i].chosen == 1) {
                      samplingMethod.selectedSample = samples[i];
                      samplingMethod.color = samples[i].color;
                      break;
                    }
                  }
                }
                //var p = JSON.parse(JSON.stringify(interpolate(samples[0].params,samples[1].params, 10)));
                Object.keys(params).forEach(function(key, index) {
                  if (!(typeof params[key] === 'object')) {
                    params[key] = samplingMethod.selectedSample.params[key];
                  }
                });
                callback(samplingMethod.selectedSample.sampleName);
              }));
              samplingMethods.push(new SamplingStrategy(params, "Interp", function(params, callback, samplingMethod) {
                var numSamples = samplingMethod.numSamples;
                if (samplingMethod.createNum == numSamples) {
                  samplingMethod.createNum = numSamples;
                  var selected = 0;
                  for (var i = 0; i < samples.length; i++) {
                    if (samples[i].chosen == 1) {
                      if (selected == 0) {
                        samplingMethod.sampleA = samples[i];
                        //samplingMethod.sampleA = samples[samples.length == 2 ? 0 : samples.length-1];
                      }
                      else {
                        samplingMethod.sampleB = samples[i];
                        //samplingMethod.sampleB = samples[1];
                        break;
                      }
                      selected++;
                    }
                  }
                }
                var percent = 1.0*((numSamples-samplingMethod.createNum)%numSamples)/(numSamples-1);
                var color = d3.scaleLinear().domain([0,1])
                  .range([samplingMethod.sampleA.color, samplingMethod.sampleB.color]);
                samplingMethod.color = color(percent);
                var i = numSamples-samplingMethod.createNum;
                var p = JSON.parse(JSON.stringify(interpolate(samplingMethod.sampleA.params, samplingMethod.sampleB.params, numSamples, i)));
                Object.keys(p).forEach(function(key, index) {
                  if (!(typeof p[key] === 'object')) {
                    params[key] = p[key];
                  }
                });
                callback("Interp("+samplingMethod.sampleA.sampleName + "," + samplingMethod.sampleB.sampleName+","+numSamples+","+samplingMethod.sampleA.id+","+samplingMethod.sampleB.id+")");
              }));
              samplingMethods.push(new SamplingStrategy(params, "Neighbor", function(params, callback, samplingMethod) {
                for (var i = 0; i < samples.length; i++) {
                  if (samples[i].chosen == 1) {
                    samplingMethod.selectedSample = samples[i];
                    //samplingMethod.color = samples[i].color;
                    break;
                  }
                }

                var p = JSON.parse(JSON.stringify(samplingMethod.selectedSample.params));
                delete p["samples"];

                api.sample({sampler:"neighbor", closeness:0.1}, p).then(function(p) {
                  Object.keys(p).forEach(function(key, index) {
                      params[key] = p[key];
                  });
                  callback("Neighbor(" + samplingMethod.selectedSample.sampleName + ")-"+currentNum);
                });

              }));
              samplingMethods.push(new SamplingStrategy(params, "Low"));
              samplingMethods.push(new SamplingStrategy(params, "High", function(params, callback) {
                  params.mpool = 10000;
                  params.cpool = 2000;
                  //params.cpool = 7500;
                  callback();
              }));
              //'#e41a1c','#377eb8','g#4daf4a','#984ea3','#ff7f00','#ffff33','#a65628','#f781bf','#999999'
              samplingMethods[0].color = "#ff7f00";
              samplingMethods[1].color = "#984ea3";
              samplingMethods[2].color = "#4daf4a";
              samplingMethods[3].numSamples = 10;
              samplingMethods[3].hasColor = false;
              samplingMethods[4].color = "#9E9E9E";
              samplingMethods[4].hasColor = false;
              samplingMethods[4].numSamples = 10;
              samplingMethods[5].color = "#f781bf";
              samplingMethods[5].numSamples = 5;
              samplingMethods[6].color = "#e41a1c";
              samplingMethods[7].color = "#377eb8";
              updateSamplingMethods();
            });
          });
        });

        function updateSamplingMethods() {
          $("#samplingMethods").html("");
          samplingMethods.forEach(function(item, index) {
            var div = $(" <div class=\"sampling\"><div style=\"position:relative; float:left; width: 75px;\">" +
              item.name + "</div><input type=\"button\" value=\"+\" onclick=\"createNewSample(samplingMethods["+index+"])\"></div>");
            var sampleNumSelect = $("<select></select>");
            for (var i = 1; i <= 10; i++) {
              var selected = i == item.numSamples ? "selected" : "";
              sampleNumSelect.append($("<option value='"+i+"'" + selected + ">"+i+"</option>"))
            }
            sampleNumSelect.change(function(){
              let selection = sampleNumSelect.val();
              item.numSamples = +selection;
            });
            div.append(sampleNumSelect);
            if (item.hasColor) {
              var colorPicker = $("<input type=\"color\" style='width:20px; height:20px;border: none;' value=\"" + item.color + "\">");
              colorPicker.change(function () {
                item.color = colorPicker.val();
              });
              div.append(colorPicker);
            }
            $("#samplingMethods").append(div);
          });
        }

        function selectAll(checked) {
          for (var i = 0; i < samples.length; i++) {
            var checkbox = $("#" + "sample-checkbox-"+samples[i].id);
            checkbox.prop('checked', checked);
            checkMultiple = (i != samples.length-1);
            checkbox.trigger("change");
          }
        }

        function selectRange(checked) {
          var first = -1;
          var next = -1;
          for (var i = 0; i < samples.length; i++) {
            if (samples[i].chosen) {
              if (first < 0) {
                first = i;
              }
              else {
                next = i;
                break;
              }
            }
          }

          if (next < 0) {
            next = first;
          }

          if (first >= 0) {
            for (var i = 0; i < samples.length; i++) {
              var checkbox = $("#" + "sample-checkbox-"+samples[i].id);
              checkbox.prop('checked', i >= first && i <= next);
              checkMultiple = (i != samples.length-1);
              checkbox.trigger("change");
            }
          }
        }

        function invertSelect() {
          for (var i = 0; i < samples.length; i++) {
            var checkbox = $("#" + "sample-checkbox-"+samples[i].id);
            checkbox.prop('checked', !checkbox.is(':checked'));
            checkMultiple = (i != samples.length-1);
            checkbox.trigger("change");
          }
        }

        function changeColor(color) {
          for (var i = 0; i < samples.length; i++) {
            var checkbox = $("#" + "sample-checkbox-"+samples[i].id);
            checkbox.prop('checked', checked);
            checkMultiple = (i != samples.length-1);
            checkbox.trigger("change");
          }
        }

        function interpColor() {
          var first = null;
          var last = null;
          var count = 0;
          for (var i = 0; i < samples.length; i++) {
            if (samples[i].chosen) {
              if (first == null) {
                first = samples[i].color;
              }

              last = samples[i].color;
              count++;
            }
          }

          if (first != null && last != null) {
            var color = d3.scaleLinear().domain([0,count-1])
              .range([first, last]);
            count = 0;
            for (var i = 0; i < samples.length; i++) {
              if (samples[i].chosen) {
                samples[i].color = color(count);
                var colorPicker = $("#" + "sample-color-"+samples[i].id);
                colorPicker.val(''+d3.color(samples[i].color).rgb().toHex());
                var checkbox = $("#" + "sample-checkbox-"+samples[i].id);
                checkbox.css('outline-color', samples[i].color);
                count++;
              }
            }
          }

        }

        function deleteSamples() {
          var newSamples = [];
          for (var i = 0; i < samples.length; i++) {
            if (samples[i].chosen == 1) {
              samples[i].delete();
              $( "#sample-info-"+samples[i].id ).remove();
            }
            else {
              newSamples.push(samples[i]);
            }
          }

          samples = newSamples;

          for (var i = 0; i < samples.length; i++) {
            sampleIndexLookup[samples[i].id] = i;
          }

          updateLineCharts();
        }

        function createNewSample(samplingMethod) {
          if (!running) {
            return;
          }
          console.log(simulations, samples.length);
          if (modelList) {
            //let model = modelList[3];//cell
            //let model = modelList[4];//nmodel
            //let model = modelList[6];//nmodel substrate
            //model.getParameters().then(function(params) {
              //params.mpool = 10000;
              //params.cpool = 7500;
              var percent = 1.0*(simulations%10)/(9.0);
              console.log(percent);
              //params.mpool = lerpParamMetaData(params, "mpool", 1000, 10000, percent);
              //params.cpool = lerpParamMetaData(params, "cpool", 750, 7500, percent);
              
              //params.cpool = lerpParamMetaData(params, "cpool", 50, 500, percent);

              //params.mpool = lerpParamMetaData(params, "mpool", 50, 1600, percent);
              //params.cpool = lerpParamMetaData(params, "cpool", 50, 1600, percent);

              //params.mpool = lerpParamMetaData(params, "mpool", 50, 750, percent);
              //params.cpool = lerpParamMetaData(params, "cpool", 50, 750, percent);

              //params.mpool = lerpParamMetaData(params, "mpool", 50, 1600, percent);
              //params.cpool = lerpParamMetaData(params, "cpool", 50, 1600, percent);
              
              //params.kon = lerpParamMetaData(params, "mpool", 0.3, 3, percent);
              //params.koff = lerpParamMetaData(params, "cpool", 0.1, 1, percent);

              //addParameter("kon", 1, 0.1, 10);
              //addParameter("koff", 0.1, 0.01, 1);

              samplingMethod.sample().then(function(s) {
                var params = s.params;
                console.log(s.name, s.params.cpool);
                params.N = 10;
                params.num = simulations;
                simulations++;

                //createSample(model, currentNum, params, 0.1, simulations, 1);
                createSample(model, currentNum, s.name, params, samplingMethod);
              });


            //});
          }

        }

        function updateSample(sample) {
          sample.update().then(function(data) {
              let prog = Math.floor(100.0*sample.nav.t/(3600*6));
              $("#progress-" + sample.id).val(''+prog);

              //sample.chosen = 0;
              sample.nav.t += 10.0;//10.0*60;
              if (/*sample.nav.m == 1 || */ sample.nav.h == 1) {
                sample.lastSpatial = JSON.parse(JSON.stringify(sample.data.samples));
              }
              sample.nav.m = sample.chosen ? 1 : 1;
              sample.nav.h = sample.chosen && tab == 0 ? 1 : 0;
              //sample.nav.t += 10.0*60;
              //if (sample.nav.t < 300) {//sample.nav.t < 3600*6) {
              if (sample.nav.t < 3600*6) {
                updateSample(sample);
              }
              else {
                /*if (sample.data.aflow < 40 || sample.data.aflow > 100 || 
                 sample.data.traction < 200 || sample.data.traction > 800
                ) {
                  const index = samples.indexOf(sample);
                  if (index > -1) {
                    samples.splice(index, 1);
                  }
                }
                else {
                  sample.chosen = 1;
                }*/

                // Enable delete:
                //sample.delete();

                //createNewSample();
              }
              updateLineCharts();
           });
        }

        function calcStatistics(key, group, sampleIndex) {
          var mean = 0.0;
          var N = group.length;

          for (var i = 0; i < group.length; i++) {
            if (group[i].data.samples) {
              mean += group[i].data.samples[sampleIndex][key];
            }
            else {
              N--;
            }
          }
          if (N > 0) {
            mean = mean/N;
          }

          var sum = 0.0;
          for (var i = 0; i < N; i++) {
            if (group[i].data.samples) {
              var diff = group[i].data.samples[sampleIndex][key]-mean;
              sum += diff*diff;
            }
          }

          var s = 0;
          if (N > 1) {
           s = Math.sqrt(sum/(N-1));
          }

          return {mean: mean, std: s, sem: s/Math.sqrt(N)};
        }

        function updateLineCharts() {

          if (tab == 0) {
            var sampleData = [];
            if (!groupSamples) {
              for (var i = 0; i < samples.length; i++) {
                var s = samples[i];
                for (var j = 0; j < s.params.samples.length; j++) {
                  if (s.data.samples) {
                    sampleData.push({name: s.name, params: s.params.samples[j], data: s.data.samples[j], chosen: s.chosen, color: s.color, hover: s.hover, id: s.id});
                  }
                }
              }
            }
            else {
              var groups = d3.nest() // nest function allows to group the calculation per level of a factor
                .key(function(d) { return d.sampleName;})
                .entries(samples);

              for (var i = 0; i < groups.length; i++) {
                var g = groups[i];
  //              var s = g.values[0];
                var s = g.values[Math.floor(g.values.length/2)];
                for (var j = 0; j < g.values.length; j++) {
                  if (g.values[j].chosen) {
                    s = g.values[j];
                    break;
                  }
                }
                for (var j = 0; j < s.params.samples.length; j++) {
                  if (s.data.samples) {
                    var aflow = calcStatistics("aflow_mean",g.values,j);
                    var traction = calcStatistics("traction_mean",g.values,j);
                    var rmc = calcStatistics("rmc_mean",g.values,j);
                    var aspect = calcStatistics("aspect_mean",g.values,j);
                    var area = calcStatistics("area_mean",g.values,j);
                    var data = {
                      aflow_mean: aflow.mean,
                      aflow_sem: aflow.sem,
                      traction_mean: traction.mean,
                      traction_sem: traction.sem,
                      rmc: rmc.mean,
                      rmc_sem: rmc.sem,
                      aspect_mean: aspect.mean,
                      aspect_sem: aspect.sem,
                      area_mean: area.mean,
                      area_sem: area.sem
                    }
                    sampleData.push({name: g.key, params: s.params.samples[j], data: data, chosen: s.chosen, color: s.color, hover: s.hover, id: s.id});
                  }
                }
              }
            }
            
            

            //console.log(sampleData);

            lineChart1.updateData(sampleData, function(d) {return d.name;}, function(d) {return d.params.substrate_k;}, function(d) {return d.data.aflow_mean;}, function(d) {return d.color;}, function(d) {return d.data.aflow_sem;});
            lineChart2.updateData(sampleData, function(d) {return d.name;}, function(d) {return d.params.substrate_k;}, function(d) {return d.data.traction_mean;}, function(d) {return d.color;}, function(d) {return d.data.traction_sem;});
            lineChart3.updateData(sampleData, function(d) {return d.name;}, function(d) {return d.params.substrate_k;}, function(d) {return d.data.rmc;}, function(d) { return d.color;}, function(d) {return d.data.rmc_sem;});
            lineChart4.updateData(sampleData, function(d) {return d.name;}, function(d) {return d.params.substrate_k;}, function(d) {return d.data.aspect_mean;}, function(d) { return d.color;}, function(d) {return d.data.aspect_sem;});
            lineChart5.updateData(sampleData, function(d) {return d.name;}, function(d) {return d.params.substrate_k;}, function(d) {return d.data.area_mean;}, function(d) { return d.color;}, function(d) {return d.data.area_sem;});

            var pccData = [];
            var params = {};
            for (var i = 0; i < samples.length; i++) {
              if (i == 0) {
                params = Object.assign(params, samples[i].params);//, samples[i].nav);
              }
              else {
                Object.keys(samples[i].params).forEach(function(key) {
                  params[key] += (+samples[i].params[key]);
                });
                Object.keys(samples[i].nav).forEach(function(key) {
                  params[key] += (+samples[i].nav[key]);
                });
              }
              var data = {};
              var data = Object.assign(data, samples[i].params);//, samples[i].nav);
              data = Object.assign(data, samples[i].data);
              delete data["N"];
              delete data["num"];
              delete data["substrate_k"];
              pccData.push({data: data, id:samples[i].id, color: samples[i].color, hover: samples[i].hover, chosen: samples[i].chosen});
            }

            if (samples.length > 0) {
              Object.keys(params).forEach(function(key) {
                  if (Math.abs((+params[key])/samples.length - samples[0].params[key]) < 0.001 || Math.abs((+params[key])/samples.length - samples[0].nav[key]) < 0.001) {
                    delete pccData[0].data[key];
                  }
              });
            }

            pcc.updateData(pccData, function(d) {return d.data; }, function(d) {return d.color; });

            var spatialData = [];
            var chosen = 0;
            if (samples.length > 0) {
              for (var i = 0; i < samples.length; i++) {
                if (samples[i].chosen) {
                  if (samples[i].lastSpatial) {
                    for (var j = 0; j < samples[i].lastSpatial.length; j+=2) {
                      spatialData.push({data: samples[i].lastSpatial[j], color: samples[i].color});
                    }
                    chosen++;
                  }
                }
              }
            }

            spatialCell.updateData(spatialData,spatialData.length/chosen,chosen);
            spatialPath.updateData(spatialData,spatialData.length/chosen,chosen);
          }
          else if (tab == 1) {
            var nameIndex = {};
            var dyanamicsData = [];
            //var index = 0;
            if (samples.length > 0) {
              for (var i = 0; i < samples.length; i++) {
                var s = samples[i];
                if (s.chosen && s.data.samples) {
                  /*for (var j = 4; j < s.data.samples.length; j++) {
                    dyanamicsData.push({name: '' + j, params: s.params.samples[j], data: s.data.samples[j], chosen: false, color: s.color, hover: s.hover, id: s.id, index: index});
                    break;
                  }*/
                  if (!(s.sampleName in nameIndex)) {
                    nameIndex[s.sampleName] = 0;
                  }
                  var index = nameIndex[s.sampleName];
                  dyanamicsData.push({name: '' + s.sampleName, params: s.params, data: s.data, chosen: false, color: s.color, hover: s.hover, id: s.id, index: index});

                  nameIndex[s.sampleName]++;
                  index++;
                }
              }
            }

            if (samples.length > 0) {
              var s = samples[0];
              var data = {};
              //if (s.data.samples) {
                //data = Object.assign(data, s.data.samples[0]); 
              //}
              data = Object.assign(data, s.data); 
              data = Object.assign(data, s.params);

              delete data["N"];
              delete data["num"];
              delete data["substrate_k"];

              var charts = $("#dynamics-charts");
              Object.keys(data).forEach(function(key, index) {
                if (!(typeof data[key] === 'object')) {
                  //console.log(key, dynamicsCharts);
                  if (!(key in dynamicsCharts)) {
                    var chartDiv = $("<div id=\"dynamic-chart-"+key+"\" class=\"dynamicsChart\"></div>");
                    var label = $("<label class='chart-label'>"+key+"</label>");
                    chartDiv.append(label);
                    charts.append(chartDiv);
                    var chart = new DynamicLineChart("dynamic-chart-"+key, "", "");
                    chart.showTicksX = false;
                    chart.yScale = getParamMetaData(s.params, key, "scale", "linear");
                    console.log(key, chart.yScale);
                    dynamicsCharts[key] = chart;
                  }

                  dynamicsCharts[key].updateData(dyanamicsData, function(d) {return d.name;}, function(d) {return d.index;}, function(d) {return key in d.params ? d.params[key] : d.data[key];}, function(d) { return d.color;}, function(d) {return null;});
                }
              });
            }
            


            /*param1.updateData(dyanamicsData, function(d) {return d.name;}, function(d) {return d.index;}, function(d) {return d.data.aflow_mean;}, function(d) { return d.color;}, function(d) {return null;});
            param2.updateData(dyanamicsData, function(d) {return d.name;}, function(d) {return d.index;}, function(d) {return d.data.traction_mean;}, function(d) { return d.color;}, function(d) {return null;});
            param3.updateData(dyanamicsData, function(d) {return d.name;}, function(d) {return d.index;}, function(d) {return d.params.cpool;}, function(d) { return d.color;}, function(d) {return null;});*/

          }

        }

        function createSample(model, name, sampleName, params, samplingMethod) {    
                var p = JSON.parse(JSON.stringify(params));
                model.create(p).then(function(sample) { 
                    samplingMethod.createNum--;
                    sample.color = "" + samplingMethod.color;
                    console.log(sample.color);
                    sample.name = name;
                    sample.sampleName = sampleName;
                    sample.nav.t = 10.0;
                    sample.nav.m = 1.0;
                    sample.nav.h = 1.0;
                    sample.id = currentNum;
                    sampleIndexLookup[sample.id] = samples.length;
                    samples.push(sample);
                    currentNum++;
                    console.log("Sample Created");
                    var div = $("<div class='sample' id='sample-info-"+sample.id+"'></div>");
                    var tempParams = JSON.parse(JSON.stringify(params));
                    delete tempParams[".metadata"];
                    var colorPicker = $("<input type=\"color\" style='width:20px; height:20px;border: none;' value=\"" + d3.color(sample.color).rgb().toHex() + "\" id='sample-color-"+sample.id+"'>");
                    div.append(colorPicker);
                    var checkbox = $("<input type='checkbox' class='sample-checkbox' id='sample-checkbox-"+sample.id+"'>");
                    var currentSample = samples.length-1;
                    checkbox.change(function () {
                      if(checkbox.is(':checked')){
                        sample.chosen = 1;
                      } else {
                        sample.chosen = 0;
                      }
                      if (!checkMultiple) {
                        updateLineCharts();
                      }
                    });
                    checkbox.css('outline-color', sample.color);
                    checkbox.css('outline-style', 'solid');
                    checkbox.css('outline-width', 'medium');
                    colorPicker.change(function () {
                      sample.color = colorPicker.val();
                      checkbox.css('outline-color', sample.color);
                    });
                    div.append(checkbox);
                    div.append("<progress id='progress-"+sample.id+"' value='0' max='100'> 0% </progress>")
                    div.append(sampleName + ": " + JSON.stringify(tempParams));
                    $("#samples").append(div);
                    
                    if (samplingMethod.createNum > 0) {
                      createNewSample(samplingMethod);
                    }

                    updateSample(sample);
                });
        }

        function interpolate(a, b, num, i) {
          //for (var i = 1; i < num-1; i++) {
            var percent = 1.0*(i%num)/(num-1);
            //percent = 0.5;
            console.log(percent);

            var params = JSON.parse(JSON.stringify(a));

            Object.keys(params).forEach(function(key, index) {
              var p = percent;
              if (!(typeof params[key] === 'object')) {
                var aVal = a[key];
                var bVal = b[key];
                if (aVal > bVal) {
                  var temp = bVal;
                  bVal = aVal;
                  aVal = temp;
                  p = 1-p;
                }
                /*else {
                  percent = 1-percent;
                }*/
                if (bVal-aVal > 0.0001) {
                  params[key] = lerpParamMetaData(params, key, aVal, bVal, p);
                }
                console.log(key, params[key]);
              }
            });

            return params;
            //createNewSample(samplingMethods[2]);
            //setTimeout(() => {  
              /*createNewSample(new SamplingStrategy(params, "Interp", function(params, callback) {
                    params = p;
                    console.log(params);
                    callback();
              }));*/
              //}, 1000);
            
          }
        //}

        function lineHover(id) {
          if (id != null) {
            samples[sampleIndexLookup[id]].hover = true;
          }
          else {
            for (var i = 0; i < samples.length; i++) {
              samples[i].hover = false;
            }
          }
          updateLineCharts();
        }

        function lineClick(id) {
          var checkbox = $("#" + "sample-checkbox-"+id);
          checkbox.prop('checked', !checkbox.is(':checked'));
          checkbox.trigger("change");
        }

        function exportCSV() {
          var rows = [];

          for (var i = 0; i < samples.length; i++) {
            if (i == 0) {
              var headers = [];
              headers.push("name");
              Object.keys(samples[i].params).forEach(function(key) {
              if (!(typeof samples[i].params[key] === 'object')) {
                headers.push(key);
              }
              });
              Object.keys(samples[i].data).forEach(function(key) {
                if (!(typeof samples[i].data[key] === 'object')) {
                  headers.push(key);
                }
              });

              rows.push(headers);
            }

            var row = [];
            row.push("\"" + samples[i].sampleName + "\"" );
            Object.keys(samples[i].params).forEach(function(key) {
              if (!(typeof samples[i].params[key] === 'object')) {
                row.push(samples[i].params[key]);
              }
            });
            Object.keys(samples[i].data).forEach(function(key) {
              if (!(typeof samples[i].data[key] === 'object')) {
                if (isNaN(parseFloat(samples[i].data[key]))) {
                  row.push("\"" + samples[i].data[key].replace("#","") + "\"" );
                }
                else {
                  row.push(samples[i].data[key]);
                }
              }
            });
            rows.push(row);
          }
          /*const rows = [
              ["name1", "city1", "some other info"],
              ["name2", "city2", "more info"]
          ];*/

          let csvContent =  
              rows.map(e => e.join(",")).join("\n");
          var encodedUri = encodeURI(csvContent);
          window.open("data:text/csv;charset=utf-8,"+encodedUri);
        }


        function exportJSON() {
          var sampleList = [];
          samples.forEach(function(item){
            sampleList.push({params: item.params, nav: item.nav, data: item.data, color: item.color, sampleName: item.sampleName});
          });
          console.log(JSON.stringify(sampleList, null, 4));
          //let csvContent = "data:text/json;charset=utf-8," + JSON.stringify(sampleList, null, 4);
          let csvContent = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(sampleList, null, 4));
          var encodedUri = csvContent; //encodeURI(csvContent);
          window.open(encodedUri);
        }

        function handleFileSelect(evt) {
          var files = evt.target.files; // FileList object


          var fileInput = document.getElementById("files");

          var reader = new FileReader();
          reader.onload = function () {
              //console.log(reader.result);
              var letters = d3.csvParse(reader.result);
              console.log(letters);
          };
          // start reading the file. When it is done, calls the onload event defined above.
          reader.readAsBinaryString(fileInput.files[0]);
        }

        document.getElementById('files').addEventListener('change', handleFileSelect, false);

        function setTab(val) {
          tab = val;
          if (tab == 1) {
            $('#data-tab').hide();
            $('#dynamics-tab').show();
          }
          else {
            $('#data-tab').show();
            $('#dynamics-tab').hide();
          }
        }

        var lineChart1 = new DynamicLineChart("my_dataviz", "Substrate Stiffness", "Mean Aflow", lineHover, lineClick);
        var lineChart2 = new DynamicLineChart("my_dataviz2", "Substrate Stiffness", "Mean Traction", lineHover, lineClick)
        var lineChart3 = new DynamicLineChart("my_dataviz3", "Substrate Stiffness", "RMC", lineHover, lineClick)
        var lineChart4 = new DynamicLineChart("my_dataviz4", "Substrate Stiffness", "Mean Aspect", lineHover, lineClick);
        var lineChart5 = new DynamicLineChart("my_dataviz5", "Substrate Stiffness", "Mean Area", lineHover, lineClick);
        lineChart1.xScale = "log";
        lineChart2.xScale = "log";
        lineChart3.xScale = "log";
        lineChart4.xScale = "log";
        lineChart5.xScale = "log";
        var pcc = new PCChart("pcc", lineHover, lineClick);
        
        var spatialCell = new SpatialCell($("#spatial"), true);
        var spatialPath = new SpatialCell($("#spatialPath"), false);

        /*var param1 = new DynamicLineChart("param1", "Substrate Stiffness", "Mean Area");
        var param2 = new DynamicLineChart("param2", "Substrate Stiffness", "Mean Area");
        var param3 = new DynamicLineChart("param3", "Substrate Stiffness", "Mean Area");*/

        </script>
</html>
