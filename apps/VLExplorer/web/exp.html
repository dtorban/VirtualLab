<html>
	<head>
		<title>Virtual Lab</title>
		<style>
      .lineChart {
        position: relative;
        float:left;
        margin-left: 0;
        width: 20%;
        height: 30%;
      }
      .popup {
        position: absolute;
        top: 50%;  /* position the top  edge of the element at the middle of the parent */
        left: 50%; /* position the left edge of the element at the middle of the parent */

        transform: translate(-50%, -50%); /* This is a shorthand of
                                            translateX(-50%) and translateY(-50%) */
        border: 1px solid;
        background-color: #F0F0F0;
      }
      .nav {position: relative; float: left; padding: 10px; width: 10%;}
      .toolbar {margin: 10px; text-align: center; width: 50px; border: 1px solid; padding: 10px;}
      .tool {background-color: rgb(79, 89, 90); width: 30px; height: 30px;margin: auto;margin-top: 10px;}
      .workarea {position: relative; float: left; margin: 10px; width: 85%;}
      .parent {display: block;position: relative;float: left;line-height: 30px;background-color: #4FA0D8;border-right:#CCC 1px solid;}
      .parent a{margin: 10px;color: #FFFFFF;text-decoration: none;}
      .parent:hover > ul {display:block;position:absolute;}
      .child {display: none;;z-index: 1;}
      .child li {background-color: #E4EFF7;line-height: 30px;border-bottom:#CCC 1px solid;border-right:#CCC 1px solid; width:100%;;z-index: 1;}
      .child li a{color: #000000;z-index: 1;}
      ul{list-style: none;margin: 0;padding: 0px; min-width:10em;}
      ul ul ul{left: 100%;top: 0;margin-left:1px;}
      li:hover {background-color: #95B4CA;}
      .parent li:hover {background-color: #F0F0F0;}
      .expand{font-size:12px;float:right;margin-right:5px;}
      #header{height: 50px; margin-top: 20px;}
      .sampling{margin-top: 2px;margin-bottom: 2px; font-size: small;}
      .sample{margin-top: 2px;margin-bottom: 2px; font-size: small;white-space: nowrap;}
      .section-title{margin-top: 15px;margin-bottom: 10px;font-weight: bold;}
      #samples{overflow: auto; height: 300px;}
      progress {
				background-color: #c0bdbd;
				width: 30px;
				margin-right: 10px;
			}
		</style>
		<script src="js/d3.v4.js"></script>
		<script src="js/jquery-3.5.1.min.js"></script>
		<script src="js/VLApi.js"></script>
		<script src="js/DynamicLineChart.js"></script>
		<script src="js/SamplingStrategy.js"></script>
	</head>
	<body>
    <div id="header">
      <ul id="menu">
        <li class="parent"><a href="#">File</a>
        <ul class="child">
          <li class="parent"><a href="#">Video Games <span class="expand">&gt;</span></a>
            <ul class="child">
            <li><a href="#">Car</a></li>
            <li><a href="#">Bike Race</a></li>
            <li><a href="#">Fishing</a></li>
            </ul>
          </li>
          <li><a href="#">Barbies</a></li>
          <li><a href="#">Teddy Bear</a></li>
          <li><a href="#">Golf Set</a></li>
        </ul>
        </li>
        <li class="parent"><a href="#">View</a>
        <ul class="child">			
          <li><a href="#">Yoyo</a></li>
          <li><a href="#">Doctor Kit</a></li>
          <li class="parent"><a href="#">Fun Puzzle<span class="expand">&gt;</span></a>
            <ul class="child">
            <li><a href="#" nowrap>Cards</a></li>
            <li><a href="#" nowrap>Numbers</a></li>
            </ul>
          </li>
          <li><a href="#">Uno Cards</a></li>
        </ul>
        </li>
        <li class="parent"><a href="#">Window</a>
        <ul class="child">			
          <li><a href="#">Battery Toys</a></li>
          <li class="parent"><a href="#">Remote Toys <span class="expand">&gt;</span></a>
            <ul class="child">
            <li><a href="#">Cars</a></li>
            <li><a href="#">Aeroplane</a></li>
            <li><a href="#">Helicopter</a></li>
            </ul>
          </li>
          <li><a href="#">Soft Toys</a>
          </li>
          <li><a href="#">Magnet Toys</a></li>
        </ul>
        </li>
      </ul>
    </div>



    <div class="workarea">
      <div id="my_dataviz" class="lineChart"></div>
      <div id="my_dataviz2" class="lineChart"></div>
      <div id="my_dataviz3" class="lineChart"></div>
      <div id="my_dataviz4" class="lineChart"></div>
      <div id="my_dataviz5" class="lineChart"></div>
    </div>

    <div class="nav">
      <!--div class="toolbar">
        <div>Tools</div>
        <div class="tool"></div>
        <div class="tool"></div>
        <div class="tool"></div>
        <div class="tool"></div>
      </div-->
      <div>
        <div class="section-title">Sampling Methods</div>
        <div id="samplingMethods">
          <div class="sampling"><div style="position:relative; float:left; width: 75px;">Low </div><input type="button" value="+" onclick="createNewSample()"></div>
          <!--div class="sampling"><div style="position:relative; float:left; width: 75px;">High </div> <input type="button" value="+" onclick="createNewSample()"></div-->
        </div>
        <!--input id="createSampling" type="button" value="Create Sampling" onclick="$('.popup').hide();$('#sampling').show();"-->
        <!--input id="sampleCreate" type="button" value="Create Sample" onclick="createNewSample()"-->
        <!--input id="toggleSim" type="button" value="Toggle Sim" onclick="running = !running;"-->
      </div>

      <div>
        <div class="section-title">Samples</div>
        <div id="samples">
        </div>
        <input type="checkbox" onchange="groupSamples = !groupSamples;" checked>Group Samples
        <!--input type="button" value="Create Template"><input type="button" value="Interpolate" onclick="interpolate(samples[0].params, samples[1].params, 3);"-->
      </div>

    </div>


    <div id="adhoc" class="popup">
      <table id="adhoc-params"></table>
      <div>Sample Name: <input id="adhoc-name" type="text"></div>
      <input id="adhoc-button" type="button" value="Submit">
    </div>


	</body>
	<script>
        var samples = [];
        var modelList = null;
        var currentNum = 0;
        var simulations = 0;
        var running = true;
        var samplingMethods = [];
        var model = null;
        var groupSamples = true;

        var color = d3.scaleLinear().domain([0,1])
          .range(["#b8c1f5", "blue"])
        console.log(color(0));
        console.log(color(0.55));

        var api = new VLApi();
        $( document ).ready(function() {
          $('.popup').hide();

          api.getModels().then(function(models) {
            console.log(models);
            modelList = models;

            model = modelList[6];

            model.getParameters().then(function(params) {
              samplingMethods.push(new SamplingStrategy(params, "Ad Hoc", function(params, callback, samplingMethod) {
                if (samplingMethod.createNum == samplingMethod.numSamples) {
                  $("#adhoc").show();
                  $("#adhoc-params").html("");
                  var input = {};
                  Object.keys(params).forEach(function(key, index) {
                    if (!(typeof params[key] === 'object')) {
                      console.log(key, params[key]);
                      var tr = $("<tr></tr>");
                      var name = $("<td>" + key + "</td>");
                      var val = $("<td></td>");
                      var inputText = $("<input type='text' value='"+ params[key] +"' size='4'>")
                      input[key] = inputText;
                      val.append(inputText);
                      tr.append(name);
                      tr.append(val);
                      $('#adhoc-params').append(tr);
                    }
                  });
                  $( "#adhoc-button" ).click(function() {
                    samplingMethod.currentInput = input;
                    Object.keys(input).forEach(function(key, index) {
                      params[key] = +input[key].val();
                    });
                    callback($("#adhoc-name").val());
                    $("#adhoc").hide();
                    $("#adhoc").unbind();
                  });
                }
                else {
                  let input = samplingMethod.currentInput;
                    Object.keys(input).forEach(function(key, index) {
                      params[key] = +input[key].val();
                  });
                  callback($("#adhoc-name").val());
                }
              }));
              samplingMethods.push(new SamplingStrategy(params, "Random", function(params, callback) {
                //var p = JSON.parse(JSON.stringify(interpolate(samples[0].params,samples[1].params, 10)));
                Object.keys(params).forEach(function(key, index) {
                  if (!(typeof params[key] === 'object')) {
                    var r = Math.random();
                    params[key] = lerpParamMetaData(params, key, getParamMetaData(params, key, "min", params[key]), getParamMetaData(params, key, "max", params[key]), r);
                  }
                });
                callback();
              }));
              samplingMethods.push(new SamplingStrategy(params, "Search"));
              samplingMethods.push(new SamplingStrategy(params, "More", function(params, callback, samplingMethod) {
                if (samplingMethod.createNum == samplingMethod.numSamples) {
                  for (var i = 0; i < samples.length; i++) {
                    if (samples[i].chosen == 1) {
                      samplingMethod.selectedSample = samples[i];
                      samplingMethod.color = samples[i].color;
                      break;
                    }
                  }
                }
                //var p = JSON.parse(JSON.stringify(interpolate(samples[0].params,samples[1].params, 10)));
                Object.keys(params).forEach(function(key, index) {
                  if (!(typeof params[key] === 'object')) {
                    params[key] = samplingMethod.selectedSample.params[key];
                  }
                });
                callback(samplingMethod.selectedSample.sampleName);
              }));
              samplingMethods.push(new SamplingStrategy(params, "Interp", function(params, callback, samplingMethod) {
                var numSamples = samplingMethod.numSamples;
                if (samplingMethod.createNum == numSamples) {
                  samplingMethod.createNum = numSamples;
                  var selected = 0;
                  for (var i = 0; i < samples.length; i++) {
                    if (samples[i].chosen == 1) {
                      if (selected == 0) {
                        samplingMethod.sampleA = samples[i];
                        //samplingMethod.sampleA = samples[samples.length == 2 ? 0 : samples.length-1];
                      }
                      else {
                        samplingMethod.sampleB = samples[i];
                        //samplingMethod.sampleB = samples[1];
                        break;
                      }
                      selected++;
                    }
                  }
                }
                var percent = 1.0*((numSamples-samplingMethod.createNum)%numSamples)/(numSamples-1);
                var color = d3.scaleLinear().domain([0,1])
                  .range([samplingMethod.sampleA.color, samplingMethod.sampleB.color]);
                samplingMethod.color = color(percent);
                var i = numSamples-samplingMethod.createNum;
                var p = JSON.parse(JSON.stringify(interpolate(samplingMethod.sampleA.params, samplingMethod.sampleB.params, numSamples, i)));
                Object.keys(p).forEach(function(key, index) {
                  if (!(typeof p[key] === 'object')) {
                    params[key] = p[key];
                  }
                });
                callback("Interp-"+(numSamples-samplingMethod.createNum));
              }));
              samplingMethods.push(new SamplingStrategy(params, "Neighbor"));
              samplingMethods.push(new SamplingStrategy(params, "Low"));
              samplingMethods.push(new SamplingStrategy(params, "High", function(params, callback) {
                  params.mpool = 10000;
                  params.cpool = 2000;
                  //params.cpool = 7500;
                  callback();
              }));
              //'#e41a1c','#377eb8','g#4daf4a','#984ea3','#ff7f00','#ffff33','#a65628','#f781bf','#999999'
              samplingMethods[0].color = "#ff7f00";
              samplingMethods[1].color = "#984ea3";
              samplingMethods[2].color = "#4daf4a";
              samplingMethods[3].numSamples = 10;
              samplingMethods[3].hasColor = false;
              samplingMethods[4].color = "#9E9E9E";
              samplingMethods[4].hasColor = false;
              samplingMethods[4].numSamples = 10;
              samplingMethods[5].hasColor = false;
              samplingMethods[5].numSamples = 10;
              samplingMethods[6].color = "#e41a1c";
              samplingMethods[7].color = "#377eb8";
              updateSamplingMethods();
            });
          });
        });

        function updateSamplingMethods() {
          $("#samplingMethods").html("");
          samplingMethods.forEach(function(item, index) {
            var div = $(" <div class=\"sampling\"><div style=\"position:relative; float:left; width: 75px;\">" +
              item.name + "</div><input type=\"button\" value=\"+\" onclick=\"createNewSample(samplingMethods["+index+"])\"></div>");
            var sampleNumSelect = $("<select></select>");
            for (var i = 1; i <= 10; i++) {
              var selected = i == item.numSamples ? "selected" : "";
              sampleNumSelect.append($("<option value='"+i+"'" + selected + ">"+i+"</option>"))
            }
            sampleNumSelect.change(function(){
              let selection = sampleNumSelect.val();
              item.numSamples = +selection;
            });
            div.append(sampleNumSelect);
            if (item.hasColor) {
              var colorPicker = $("<input type=\"color\" style='width:20px; height:20px;border: none;' value=\"" + item.color + "\">");
              colorPicker.change(function () {
                item.color = colorPicker.val();
              });
              div.append(colorPicker);
            }
            $("#samplingMethods").append(div);
          });
        }

        function createNewSample(samplingMethod) {
          if (!running) {
            return;
          }
          console.log(simulations, samples.length);
          if (modelList) {
            //let model = modelList[3];//cell
            //let model = modelList[4];//nmodel
            //let model = modelList[6];//nmodel substrate
            //model.getParameters().then(function(params) {
              //params.mpool = 10000;
              //params.cpool = 7500;
              var percent = 1.0*(simulations%10)/(9.0);
              console.log(percent);
              //params.mpool = lerpParamMetaData(params, "mpool", 1000, 10000, percent);
              //params.cpool = lerpParamMetaData(params, "cpool", 750, 7500, percent);
              
              //params.cpool = lerpParamMetaData(params, "cpool", 50, 500, percent);

              //params.mpool = lerpParamMetaData(params, "mpool", 50, 1600, percent);
              //params.cpool = lerpParamMetaData(params, "cpool", 50, 1600, percent);

              //params.mpool = lerpParamMetaData(params, "mpool", 50, 750, percent);
              //params.cpool = lerpParamMetaData(params, "cpool", 50, 750, percent);

              //params.mpool = lerpParamMetaData(params, "mpool", 50, 1600, percent);
              //params.cpool = lerpParamMetaData(params, "cpool", 50, 1600, percent);
              
              //params.kon = lerpParamMetaData(params, "mpool", 0.3, 3, percent);
              //params.koff = lerpParamMetaData(params, "cpool", 0.1, 1, percent);

              //addParameter("kon", 1, 0.1, 10, "log");
              //addParameter("koff", 0.1, 0.01, 1, "log");

              samplingMethod.sample().then(function(s) {
                var params = s.params;
                console.log(s.name, s.params.cpool);
                params.N = 10;
                params.num = simulations;
                simulations++;

                //createSample(model, currentNum, params, 0.1, simulations, 1);
                createSample(model, currentNum, s.name, params, samplingMethod);
              });


            //});
          }

        }

        function updateSample(sample) {
          sample.update().then(function(data) {
              let prog = Math.floor(100.0*sample.nav.t/(3600*6));
              $("#progress-" + sample.id).val(''+prog);

              //sample.chosen = 0;
              sample.nav.t += 10.0;//10.0*60;
              //sample.nav.t += 10.0*60;
              //if (sample.nav.t < 300) {//sample.nav.t < 3600*6) {
              if (sample.nav.t < 3600*6) {
                updateSample(sample);
              }
              else {
                /*if (sample.data.mean_aflow < 40 || sample.data.mean_aflow > 100 || 
                 sample.data.mean_traction < 200 || sample.data.mean_traction > 800
                ) {
                  const index = samples.indexOf(sample);
                  if (index > -1) {
                    samples.splice(index, 1);
                  }
                }
                else {
                  sample.chosen = 1;
                }*/
                sample.delete();
                //createNewSample();
              }
              updateLineCharts();
           });
        }

        function calcStatistics(key, group, sampleIndex) {
          var mean = 0.0;
          var N = group.length;

          for (var i = 0; i < group.length; i++) {
            if (group[i].data.samples) {
              mean += group[i].data.samples[sampleIndex][key];
            }
            else {
              N--;
            }
          }
          if (N > 0) {
            mean = mean/N;
          }

          var sum = 0.0;
          for (var i = 0; i < N; i++) {
            if (group[i].data.samples) {
              var diff = group[i].data.samples[sampleIndex][key]-mean;
              sum += diff*diff;
            }
          }

          var s = 0;
          if (N > 1) {
           s = Math.sqrt(sum/(N-1));
          }

          return {mean: mean, std: s, sem: s/Math.sqrt(N)};
        }

        function updateLineCharts() {
          var sampleData = [];
          if (!groupSamples) {
            for (var i = 0; i < samples.length; i++) {
              var s = samples[i];
              for (var j = 0; j < s.params.samples.length; j++) {
                if (s.data.samples) {
                  sampleData.push({name: s.name, params: s.params.samples[j], data: s.data.samples[j], chosen: s.chosen, color: s.color, hover: s.hover, id: s.id});
                }
              }
            }
          }
          else {
            var groups = d3.nest() // nest function allows to group the calculation per level of a factor
              .key(function(d) { return d.sampleName;})
              .entries(samples);

            for (var i = 0; i < groups.length; i++) {
              var g = groups[i];
              var s = g.values[0];
              for (var j = 0; j < s.params.samples.length; j++) {
                if (s.data.samples) {
                  var aflow = calcStatistics("mean_aflow",g.values,j);
                  var traction = calcStatistics("mean_traction",g.values,j);
                  var rmc = calcStatistics("rmc",g.values,j);
                  var aspect = calcStatistics("mean_aspect",g.values,j);
                  var area = calcStatistics("mean_area",g.values,j);
                  var data = {
                    mean_aflow: aflow.mean,
                    sem_aflow: aflow.sem,
                    mean_traction: traction.mean,
                    sem_traction: traction.sem,
                    rmc: rmc.mean,
                    sem_rmc: rmc.sem,
                    mean_aspect: aspect.mean,
                    sem_aspect: aspect.sem,
                    mean_area: area.mean,
                    sem_area: area.sem
                  }
                  sampleData.push({name: g.key, params: s.params.samples[j], data: data, chosen: s.chosen, color: s.color, hover: s.hover, id: s.id});
                }
              }
            }
          }
          
          

          //console.log(sampleData);

          lineChart1.updateData(sampleData, function(d) {return d.name;}, function(d) {return d.params.substrate_k;}, function(d) {return d.data.mean_aflow;}, function(d) {return d.color;}, function(d) {return d.data.sem_aflow;});
          lineChart2.updateData(sampleData, function(d) {return d.name;}, function(d) {return d.params.substrate_k;}, function(d) {return d.data.mean_traction;}, function(d) {return d.color;}, function(d) {return d.data.sem_traction;});
          lineChart3.updateData(sampleData, function(d) {return d.name;}, function(d) {return d.params.substrate_k;}, function(d) {return d.data.rmc;}, function(d) { return d.color;}, function(d) {return d.data.sem_rmc;});
          lineChart4.updateData(sampleData, function(d) {return d.name;}, function(d) {return d.params.substrate_k;}, function(d) {return d.data.mean_aspect;}, function(d) { return d.color;}, function(d) {return d.data.sem_aspect;});
          lineChart5.updateData(sampleData, function(d) {return d.name;}, function(d) {return d.params.substrate_k;}, function(d) {return d.data.mean_area;}, function(d) { return d.color;}, function(d) {return d.data.sem_area;});

        }

        function createSample(model, name, sampleName, params, samplingMethod) {    
                var p = JSON.parse(JSON.stringify(params));
                model.create(p).then(function(sample) { 
                    samplingMethod.createNum--;
                    sample.color = "" + samplingMethod.color;
                    console.log(sample.color);
                    sample.name = name;
                    sample.sampleName = sampleName;
                    sample.nav.t = 10.0;
                    sample.id = samples.length;
                    samples.push(sample);
                    currentNum++;
                    console.log("Sample Created");
                    var div = $("<div class='sample'></div>");
                    var tempParams = JSON.parse(JSON.stringify(params));
                    delete tempParams[".metadata"];
                    var checkbox = $("<input type='checkbox' class='sample-checkbox' id='sample-checkbox-"+sample.id+"'>");
                    var currentSample = samples.length-1;
                    checkbox.change(function () {
                      if(checkbox.is(':checked')){
                          samples[currentSample].chosen = 1;
                      } else {
                          samples[currentSample].chosen = 0;
                      }
                      console.log(currentSample, samples[currentSample].chosen);
                    });
                    checkbox.css('outline-color', sample.color);
                    checkbox.css('outline-style', 'solid');
                    checkbox.css('outline-width', 'medium');
                    div.append(checkbox);
                    div.append("<progress id='progress-"+(samples.length-1)+"' value='0' max='100'> 0% </progress>")
                    div.append(sampleName + ": " + JSON.stringify(tempParams));
                    $("#samples").append(div);
                    
                    if (samplingMethod.createNum > 0) {
                      createNewSample(samplingMethod);
                    }

                    updateSample(sample);
                });
        }

        function interpolate(a, b, num, i) {
          //for (var i = 1; i < num-1; i++) {
            var percent = 1.0*(i%num)/(num-1);
            //percent = 0.5;
            console.log(percent);

            var params = JSON.parse(JSON.stringify(a));

            Object.keys(params).forEach(function(key, index) {
              if (!(typeof params[key] === 'object')) {
                var aVal = a[key];
                var bVal = b[key];
                if (aVal > bVal) {
                  var temp = bVal;
                  bVal = aVal;
                  aVal = temp;
                  percent = 1-percent;
                }
                if (bVal-aVal > 0.0001) {
                  params[key] = lerpParamMetaData(params, key, aVal, bVal, percent);
                }
                console.log(key, params[key]);
              }
            });

            return params;
            //createNewSample(samplingMethods[2]);
            //setTimeout(() => {  
              /*createNewSample(new SamplingStrategy(params, "Interp", function(params, callback) {
                    params = p;
                    console.log(params);
                    callback();
              }));*/
              //}, 1000);
            
          }
        //}

        function lineHover(id) {
          if (id) {
            samples[id].hover = true;
          }
          else {
            for (var i = 0; i < samples.length; i++) {
              samples[i].hover = false;
            }
          }
          updateLineCharts();
        }

        function lineClick(id) {
          var checkbox = $("#" + "sample-checkbox-"+id);
          checkbox.prop('checked', !checkbox.is(':checked'));
          checkbox.trigger("change");
        }

        var lineChart1 = new DynamicLineChart("my_dataviz", "Substrate Stiffness", "Mean Aflow", lineHover, lineClick);
        var lineChart2 = new DynamicLineChart("my_dataviz2", "Substrate Stiffness", "Mean Traction", lineHover, lineClick);
        var lineChart3 = new DynamicLineChart("my_dataviz3", "Substrate Stiffness", "RMC", lineHover, lineClick);
        var lineChart4 = new DynamicLineChart("my_dataviz4", "Substrate Stiffness", "Mean Aspect", lineHover, lineClick);
        var lineChart5 = new DynamicLineChart("my_dataviz5", "Substrate Stiffness", "Mean Area", lineHover, lineClick);
        
        </script>
</html>
